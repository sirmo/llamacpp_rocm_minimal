# AGENTS.md

## Project Overview
This repository builds and runs **llama.cpp** on AMD GPUs (gfx1151) using ROCm HIP support. It provides two Docker images:
- **Full image (`llama-cpp-gfx1151`)** – all ROCm libraries, ~32 GB virtual size.
- **Minimal image (`llama-cpp-gfx1151.minimal.*`)** – stripped down to only the required runtime components (~4 GB virtual, ~1.8 GB actual).

## Key Components & Workflow
| Component | Purpose | Highlights |
|-----------|---------|------------|
| `Dockerfile` | Multi‑stage build: ROCm base → builder (llama.cpp) → runtime. | Caches ROCm layer, fast iterative builds.
| `Dockerfile.minimal` | Creates a lean image from the full one, stripping binaries and copying only needed libraries & symlinks. | Adds explicit symlinks for LLVM bitcode (`llvm`, `amdgcn`). Strips binaries to reduce size.
| `Makefile` | Orchestrates building, saving, loading, running, cleaning, and comparing images. | New targets: `save-image-zst`, `save-minimal-image-zst`, `compare-exports`. Updated `all` workflow.
| `README.md` | User guide covering build commands, run scripts, GPU verification, troubleshooting, and image comparison table. | Added minimal‑image instructions, symlink validation steps.
| `SIZE_COMPARISON.md` (not shown) | Provides size metrics for full vs minimal images.

## Build Process
1. **Full Image**
   ```bash
   docker build -t llama-cpp-gfx1151 . 2>&1 | tee build.log
   ```
   - Installs ROCm (`rocm-base` stage) – cached for future builds.
   - Compiles llama.cpp with HIP flags.
2. **Minimal Image** (requires full image)
   ```bash
   docker build -f Dockerfile.minimal -t llama-cpp-gfx1151.minimal .
   ```
   - Strips binaries (`strip --strip-all`).
   - Copies essential system libs, ROCm runtime libs, gfx1151‑specific kernels, and bitcode.
   - Creates symlinks:
     - `llvm -> ./lib/llvm`
     - `amdgcn -> lib/llvm/lib/clang/20/lib/amdgcn`
3. **Export & Compression**
   - `make save-image` / `save-minimal-image` → uncompressed `.tar`.
   - `make save-image-zst` / `save-minimal-image-zst` → ZSTD‑compressed archives.
4. **Comparison**
   - `make compare-docker` – shows Docker image sizes (original only).
   - `make compare-exports` – lists file sizes of exported `.tar*` files.

## Makefile Enhancements
- Added `EXPORT_DIR := ./images` for a central export location.
- Added `MODEL_BASE_PATH ?= /home/md/lmodels` as a single source of truth for model location.
- New phony targets:
  - `save-image-zst`, `save-minimal-image-zst`
  - `compare-exports`
  - `run MODEL=<name>` - Runs models from host using wrapper script
- Updated workflow target `all` to run: `build → minimal → save‑minimal‑image‑zst → compare‑sizes` (now uses the new comparison commands).
- Clean-up targets for containers, images, and exported files.

## Documentation Updates
- **README.md** now includes:
  - Detailed build steps for both images.
  - Explicit symlink verification (`ls -la /opt/rocm‑7.1.0/`).
  - Troubleshooting sections covering GPU detection, minimal image failures, and HIP support validation.
  - Image comparison table with virtual/actual sizes and savings.
- **SIZE_COMPARISON.md** (maintained separately) tracks size metrics over time.

## Scripts & Utilities
- `run/` directory contains pre‑configured shell scripts for various models (e.g., Qwen3 Coder 30B, GPT-OSS 120B, GLM 4.5 Air). All scripts now use `MODEL_BASE_PATH` environment variable instead of hardcoded paths.
- `run_wrapper.sh` - Wrapper script that runs model scripts from outside the container. Takes `MODEL_BASE_PATH` from environment or Makefile, mounts the model directory, and executes the specified model script inside Docker.
- Helper scripts (`build-minimal.sh`, `filter_strace.py`) aid debugging and minimal image creation.

## Future Agent Guidance
1. **Start Point** – Use `make all` to ensure a fresh full build, minimal image, compressed export, and size comparison.
2. **Modifying ROCm Version** – Adjust `ROCM_VERSION` and `UBUNTU_VERSION` in the Makefile or via `docker build --build-arg`.
3. **Adding New Targets** – Follow existing pattern: declare target, create necessary directories, echo progress, run Docker commands, then list resulting files.
4. **Testing Changes** – After any edit, run the relevant `make compare‑exports` and/or `make compare‑docker` to verify size expectations.
5. **Symlink Integrity** – Any change affecting ROCm paths must preserve the two symlinks (`llvm`, `amdgcn`) in the minimal Dockerfile; otherwise model loading may fail with OOM errors.

---
*Generated by OpenCode to give future autonomous agents a concise yet comprehensive roadmap of the project’s architecture, build pipeline, and maintenance conventions.*